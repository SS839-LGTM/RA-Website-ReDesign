<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Axe runner â€” networks</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: system-ui, -apple-system, 'Segoe UI', Roboto, Arial; padding: 1rem; }
    iframe { width: 100%; height: 70vh; border: 1px solid #ddd; border-radius: 6px; }
    pre { white-space: pre-wrap; word-break: break-word; max-height: 30vh; overflow: auto; background:#f6f8fa; padding:1rem; border-radius:6px; }
    .controls { display:flex; gap:0.5rem; align-items:center; margin-bottom:0.75rem; }
    .muted { color:#666; font-size:0.9rem }
    .btn { padding:0.5rem 0.8rem; border-radius:6px; border:1px solid #ddd; cursor:pointer; background:white }
    .btn.primary { background:#074da6; color:#fff; border-color:#074da6 }
  </style>
</head>
<body>
  <h1>Run axe on <code>networks.html</code></h1>
  <p class="muted">This page loads the target page in an iframe (same origin local file) and runs <code>axe-core</code>. Results are shown below and can be downloaded as JSON.</p>
  <div class="controls">
    <button id="run" class="btn primary">Run axe</button>
    <button id="download" class="btn" disabled>Download JSON</button>
    <span id="status" class="muted">Idle</span>
  </div>

  <iframe id="target" src="../networks.html" title="networks preview"></iframe>

  <h2>Results</h2>
  <pre id="output">No results yet. Click "Run axe" to start.</pre>

  <script src="../assets/axe.min.js"></script>
  <script>
    const runBtn = document.getElementById('run');
    const out = document.getElementById('output');
    const status = document.getElementById('status');
    const downloadBtn = document.getElementById('download');
    const iframe = document.getElementById('target');

    function setStatus(s){ status.textContent = s }

    async function runAxeOnIframe(){
      setStatus('Running...');
      out.textContent = 'Running axe, please wait...';
      try{
        // Ensure iframe is loaded
        const doc = iframe.contentDocument || iframe.contentWindow.document;
        if(!doc){ throw new Error('Could not access iframe document (same origin required).') }

        // Inject axe into iframe if not present
        if(!iframe.contentWindow.axe){
          // Create a script element in the iframe to load axe
          const s = doc.createElement('script');
          s.src = '../assets/axe.min.js';
          doc.head.appendChild(s);
          // Wait for axe to load
          await new Promise((resolve, reject)=>{
            s.onload = resolve;
            s.onerror = ()=>reject(new Error('Failed to load axe in iframe'));
            // fallback timeout
            setTimeout(()=>{ if(!iframe.contentWindow.axe) reject(new Error('axe did not load in time')); }, 3000);
          });
        }

        // Run axe in the iframe context
        const results = await iframe.contentWindow.axe.run();
        out.textContent = JSON.stringify(results, null, 2);
        setStatus('Completed');

        // Prepare download
        const blob = new Blob([JSON.stringify(results, null, 2)], {type: 'application/json'});
        const url = URL.createObjectURL(blob);
        downloadBtn.href = url;
        downloadBtn.download = 'axe-results-networks.json';
        downloadBtn.disabled = false;
        downloadBtn.onclick = () => { setTimeout(()=>URL.revokeObjectURL(url), 1000); };
      }catch(e){
        setStatus('Error');
        out.textContent = 'Error running axe: ' + (e && e.message ? e.message : String(e));
        console.error(e);
      }
    }

    runBtn.addEventListener('click', runAxeOnIframe);

    // Allow pressing Enter to run when focused
    window.addEventListener('keydown', (e)=>{ if(e.key === 'Enter' && document.activeElement === runBtn) runAxeOnIframe(); });
  </script>
</body>
</html>
